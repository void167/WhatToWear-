import requests
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup, KeyboardButton, ReplyKeyboardMarkup
from aiogram import F
import logging
import asyncio

TOKEN = ""
WEATHER_API = ""

bot = Bot(token=TOKEN)
dp = Dispatcher()


# ---------- ÐŸÐžÐ“ÐžÐ”Ð ----------
def get_weather(city: str):
    url = (
        f"https://api.openweathermap.org/data/2.5/weather?"
        f"q={city}&appid={WEATHER_API}&units=metric&lang=ru"
    )
    res = requests.get(url).json()

    if res.get("main"):
        temp = res["main"]["temp"]
        desc = res["weather"][0]["description"]
        return temp, desc
    return None, None


def get_weather_by_coords(lat, lon):
    url = (
        f"https://api.openweathermap.org/data/2.5/weather?"
        f"lat={lat}&lon={lon}&appid={WEATHER_API}&units=metric&lang=ru"
    )
    res = requests.get(url).json()

    if res.get("main"):
        city = res.get("name", "ÐÐµÐ¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ñ‹Ð¹ Ð³Ð¾Ñ€Ð¾Ð´")
        temp = res["main"]["temp"]
        desc = res["weather"][0]["description"]
        return city, temp, desc
    return None, None, None


# ---------- Ð¡ÐžÐ’Ð•Ð¢Ð« ÐŸÐž ÐžÐ”Ð•Ð–Ð”Ð• ----------
def clothes_advice(temp: float) -> str:
    if temp <= -15:
        return "ðŸ¥¶ ÐžÑ‡ÐµÐ½ÑŒ Ñ…Ð¾Ð»Ð¾Ð´Ð½Ð¾! ÐŸÑƒÑ…Ð¾Ð²Ð¸Ðº, Ñ‚ÐµÑ€Ð¼ÑƒÑ…Ð°, ÑˆÐ°Ð¿ÐºÐ°, Ð¿ÐµÑ€Ñ‡Ð°Ñ‚ÐºÐ¸."
    elif -15 < temp <= -5:
        return "â„ï¸ Ð¥Ð¾Ð»Ð¾Ð´Ð½Ð¾. Ð¢Ñ‘Ð¿Ð»Ð°Ñ ÐºÑƒÑ€Ñ‚ÐºÐ°, ÑˆÐ°Ñ€Ñ„ Ð¸ ÑˆÐ°Ð¿ÐºÐ°."
    elif -5 < temp <= 5:
        return "ðŸŒ« ÐŸÑ€Ð¾Ñ…Ð»Ð°Ð´Ð½Ð¾. ÐÐ°Ð´ÐµÐ½ÑŒ ÐºÑƒÑ€Ñ‚ÐºÑƒ Ð¸Ð»Ð¸ Ð¿Ð°Ð»ÑŒÑ‚Ð¾."
    elif 5 < temp <= 15:
        return "ðŸ‚ Ð›ÐµÐ³ÐºÐ°Ñ ÐºÑƒÑ€Ñ‚ÐºÐ° Ð¸Ð»Ð¸ Ñ…ÑƒÐ´Ð¸."
    elif 15 < temp <= 23:
        return "ðŸ˜Š ÐšÐ¾Ð¼Ñ„Ð¾Ñ€Ñ‚Ð½Ð¾. Ð¤ÑƒÑ‚Ð±Ð¾Ð»ÐºÐ° Ð¸ Ð´Ð¶Ð¸Ð½ÑÑ‹ Ð½Ð¾Ñ€Ð¼."
    else:
        return "ðŸ¥µ Ð–Ð°Ñ€Ð°! Ð¨Ð¾Ñ€Ñ‚Ñ‹, Ð¼Ð°Ð¹ÐºÐ° Ð¸ Ð²Ð¾Ð´Ð°."


# ---------- ÐšÐÐžÐŸÐšÐ˜ ----------
def main_menu():
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="ðŸŒ† ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿Ð¾Ð³Ð¾Ð´Ñƒ Ð¿Ð¾ Ð³Ð¾Ñ€Ð¾Ð´Ñƒ", callback_data="by_city")],
            [InlineKeyboardButton(text="ðŸ“ ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ð¿Ð¾ Ð³ÐµÐ¾Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸", callback_data="by_geo")]
        ]
    )


def location_keyboard():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð³ÐµÐ¾Ð»Ð¾ÐºÐ°Ñ†Ð¸ÑŽ ðŸ“", request_location=True)]
        ],
        resize_keyboard=True,
        one_time_keyboard=True
    )


# ---------- Ð¥Ð•ÐÐ”Ð›Ð•Ð Ð« ----------
@dp.message(Command("start"))
async def start(message: types.Message):
    await message.answer(
        "Ð—Ð´Ð°Ñ€Ð¾Ð²Ð°, Ð±Ñ€Ð°Ñ‚! Ð¯ Ð¿Ð¾Ð´ÑÐºÐ°Ð¶Ñƒ, Ñ‡Ñ‚Ð¾ Ð½Ð°Ð´ÐµÑ‚ÑŒ Ð¿Ð¾ Ð¿Ð¾Ð³Ð¾Ð´Ðµ ðŸ˜Ž\n"
        "Ð’Ñ‹Ð±ÐµÑ€Ð¸ ÑÐ¿Ð¾ÑÐ¾Ð±:",
        reply_markup=main_menu()
    )


# --- Inline ÐºÐ½Ð¾Ð¿ÐºÐ°: Ð²Ñ‹Ð±Ð¾Ñ€ Ð³Ð¾Ñ€Ð¾Ð´Ð° ---
@dp.callback_query(F.data == "by_city")
async def choose_city(call: types.CallbackQuery):
    await call.message.answer("Ð’Ð²ÐµÐ´Ð¸ Ð³Ð¾Ñ€Ð¾Ð´, Ð±Ñ€Ð°Ñ‚ ðŸ‘‡")
    await call.answer()


# --- Inline ÐºÐ½Ð¾Ð¿ÐºÐ°: Ð³ÐµÐ¾Ð»Ð¾ÐºÐ°Ñ†Ð¸Ñ ---
@dp.callback_query(F.data == "by_geo")
async def ask_geo(call: types.CallbackQuery):
    await call.message.answer(
        "ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒ Ð¼Ð½Ðµ ÑÐ²Ð¾ÑŽ Ð»Ð¾ÐºÐ°Ñ†Ð¸ÑŽ, Ð±Ñ€Ð°Ñ‚ ðŸ”¥",
        reply_markup=location_keyboard()
    )
    await call.answer()


# --- ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð³Ð¾Ñ€Ð¾Ð´Ð° Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼ ---
@dp.message(F.text)
async def weather_by_city(message: types.Message):
    city = message.text.strip()
    temp, desc = get_weather(city)

    if temp is None:
        await message.answer("Ð¢Ð°ÐºÐ¾Ð¹ Ð³Ð¾Ñ€Ð¾Ð´ Ð½Ð°Ð¹Ñ‚Ð¸ Ð½Ðµ ÑÐ¼Ð¾Ð³. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ ÐµÑ‰Ñ‘ ðŸ™")
        return

    advise = clothes_advice(temp)

    await message.answer(
        f"ðŸŒ Ð“Ð¾Ñ€Ð¾Ð´: {city}\n"
        f"ðŸŒ¡ Ð¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°: {temp}Â°C\n"
        f"â˜ï¸ ÐŸÐ¾Ð³Ð¾Ð´ÐºÐ°: {desc}\n\n"
        f"ðŸ‘• Ð¡Ð¾Ð²ÐµÑ‚: {advise}",
        reply_markup=main_menu()
    )


# --- ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð³ÐµÐ¾Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸ ---
@dp.message(F.location)
async def weather_by_location(message: types.Message):
    lat = message.location.latitude
    lon = message.location.longitude

    city, temp, desc = get_weather_by_coords(lat, lon)

    if temp is None:
        await message.answer("ÐÐµ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¾ÑÑŒ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð³Ð¾Ð´Ñƒ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ Ð¿Ð¾Ð·Ð¶Ðµ ðŸ‘€")
        return

    advise = clothes_advice(temp)

    await message.answer(
        f"ðŸ“ ÐœÐµÑÑ‚Ð¾: {city}\n"
        f"ðŸŒ¡ Ð¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°: {temp}Â°C\n"
        f"â˜ï¸ ÐŸÐ¾Ð³Ð¾Ð´ÐºÐ°: {desc}\n\n"
        f"ðŸ‘• Ð¡Ð¾Ð²ÐµÑ‚: {advise}",
        reply_markup=main_menu()
    )


# ---------- Ð¡Ð¢ÐÐ Ð¢ ----------
async def main():

    await dp.start_polling(bot)

if __name__ == '__main__':
    logging.basicConfig(level=logging.INFO)
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("Exit")
